<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>assigned_tasks</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="../../../3700.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#pmod-amp2-pinout">Pmod AMP2 Pinout</a></li>
<li><a href="#how-pwm-works">How PWM works</a>
<ul>
<li><a href="#the-pwm-modules-behavior">The PWM module’s
behavior</a></li>
<li><a href="#led-dimmer">LED Dimmer</a></li>
</ul></li>
<li><a href="#part-2-audio-signal-generation">Part 2: Audio Signal
Generation</a>
<ul>
<li><a href="#pwm-square-wave-tones">PWM Square-Wave Tones</a></li>
<li><a href="#top-module-design">Top Module Design</a></li>
<li><a href="#gain-and-shutdown_l-outputs">Gain and Shutdown_l
outputs</a></li>
<li><a href="#constraining-the-design">Constraining the Design</a></li>
<li><a href="#connecting-the-pmod-amp2">Connecting the Pmod
AMP2</a></li>
<li><a href="#synthesize-implement-program-test">Synthesize, Implement,
Program, Test</a></li>
</ul></li>
</ul>
</nav>
<h1 id="introduction">Introduction</h1>
<p>Modulation and signal conversion In this lab, we will explore a
one-bit ON/OFF modulation technique known as <span class="alert">Pulse
Width Modulation (PWM)</span>. We will use this technique to convert a
digital signal into an analog signal, so that we can deliver audio tones
to the AMP2 Pmod. This module only accepts one input signal from the
FPGA, but that signal is supposed to be analog, and the FPGA only
produces digital signals. Methods like PWM allow us to emulate an analog
level via fast digital switching.</p>
<p><img src="figures/3700_2_1_PMOD_Amp2.png" style="width:33.0%" /></p>
<p>For this lab, you will also need <span class="alert">a pair of
headphones</span>. The PMod Amp2 module tends to produce a loud output,
so you may also benefit from an <span class="alert">analog inline volume
control</span> like this one (I found it on Amazon):</p>
<p><img src="figures/volume_control.png" style="width:25.0%" /></p>
<h1 id="pmod-amp2-pinout">Pmod AMP2 Pinout</h1>
<p>According to <a
href="the%20Amp2%20Reference%20page">https://reference.digilentinc.com/reference/pmod/pmodamp2/start</a>,
the pins are as shown on the right. Pin 1 is the “top” pin on the
circuit board, and is labeled with a <code
class="sourceCode verilog"><span class="dv">1</span></code>. Ignore the
<code class="sourceCode verilog">J1</code> label at the bottom of the
module, it is NOT a pin label.</p>
<p>The main pins are:</p>
<ul>
<li><strong>Ain</strong> – analog input, a single digital signal that
will be filtered by the module.</li>
<li><strong>Gain</strong> – digital gain select. High-volume mode when
low, normal-mode when high.</li>
<li><strong><span class="math inline">∼</span>Shutdown</strong> –
shutdown the module when this is zero, to save power or mute the
output.</li>
</ul>
<p><img src="figures/pinout.png" /></p>
<h1 id="how-pwm-works">How PWM works</h1>
<p>The AMP2 Pmod contains a <span class="alert">passive low-pass
filter</span>. The word “passive” means that it consists only resistors
and capacitors. The phrase “low-pass filter” means that it smooths out
fast switching signals, leaving only the average signal value.</p>
<p>This animation illustrates the concept:</p>
<p><object data="figures/pwm_animation.svg"></object></p>
<p>We can convey a signal by varying the pulse widths <span
class="alert">as long as the signal bandwidth is much lower than the
pulse frequency.</span> In other words, if the signal changes very
slowly, so that the signal’s value is approximately constant during one
or more pulse periods, then we can use the pulse widths as a <span
class="alert">carrier</span> to convey the signal. The signal is then
retrieved, and the carrier removed, by using a low-pass filter to reject
the fast-changing pulses.</p>
<p>Applications of PWM:</p>
<ul>
<li>Dimming LED lighting</li>
<li>Audio encoding</li>
<li>Servo motor positioning (for example, an angle between <span
class="math inline">0<sup>∘</sup></span> to <span
class="math inline">180<sup>∘</sup></span> is communicated via PWM)</li>
</ul>
<p>In this lab, you will...</p>
<ul>
<li>Create an 8-bit, 256-level PWM module.</li>
<li>Test the module using an LED-dimming project on the Basys3
board.</li>
<li>Create a Sine Wave Synthesizer with PWM audio output</li>
</ul>
<h2 id="the-pwm-modules-behavior">The PWM module’s behavior</h2>
<p>Since our PWM will modulate an 8-bit digital input named <span
class="alert">din</span>, it must support 256 distinct pulse widths,
ranging from 0 to 255. This means the PWM signal must have a pulse
period of 256 clock cycles.</p>
<p>For each period of the PWM signal, the output <span
class="alert">sout</span> should be <span class="alert">HIGH</span>
during the first <span class="alert">din</span> clock cycles, and should
fall <span class="alert">LOW</span> during the remainder of the 255
cycles that comprise the pulse period.</p>
<p>See if you can produce a module, in Verilog, with the indicated
behavior. Create a testbench to verify your design.</p>
<h2 id="led-dimmer">LED Dimmer</h2>
<p>Once you have created and verified a PWM module design, test it by
making an LED dimmer, with the source shown below. This module uses a
PWM signal to gradually brighten, then gradually dim all the LEDs on the
Basys3 board. Study the module and make sure you understand how it
works. Synthesize, implement, generate a bit stream and then demonstrate
the design on your board.</p>
<div class="sourceCode" id="cb1" data-language="Verilog"><pre
class="sourceCode verilog"><code class="sourceCode verilog"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ot">`timescale 1ns / 1ps</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> dim_leds<span class="op">(</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">input</span>         sys_clk<span class="op">,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">output</span> <span class="op">[</span><span class="dv">15</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> LED<span class="op">,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">output</span> <span class="op">[</span><span class="dv">3</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span>  an<span class="op">,</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">output</span> <span class="op">[</span><span class="dv">6</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span>  seg</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// PWM signals</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">reg</span> <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> din<span class="op">;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">wire</span>      sout<span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Signals for clock divider:</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">integer</span>   count<span class="op">;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">reg</span>       div_clk<span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// State variable:</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">reg</span>       count_up<span class="op">;</span> <span class="co">// brighten (1) or dim (0)</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Assign all LEDs to equal the PWM signal</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">assign</span> LED <span class="op">=</span> <span class="op">{</span><span class="dv">16</span><span class="op">{</span>sout<span class="op">}};</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Instantiate the PWM:</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    pwm_0 MOD1<span class="op">(</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        .clk<span class="op">(</span>sys_clk<span class="op">),</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        .din<span class="op">(</span>din<span class="op">),</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        .sout<span class="op">(</span>sout<span class="op">)</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>     <span class="op">);</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize reg signals</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">initial</span> <span class="kw">begin</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>        din <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        count_up <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co">// Implement a clock divider:</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> sys_clk<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>count <span class="op">&gt;=</span> 500_000<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>            count <span class="op">&lt;=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>            div_clk <span class="op">&lt;=</span> <span class="op">~</span>div_clk<span class="op">;</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">end</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">else</span> </span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>            count <span class="op">&lt;=</span> count <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Main brighten/dim process:</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> div_clk<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Adjust the PWM brightness level</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>count_up<span class="op">)</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>           din <span class="op">&lt;=</span> din <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">else</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>           din <span class="op">&lt;=</span> din <span class="op">-</span> <span class="dv">1</span><span class="op">;</span>       </span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>       <span class="co">// If we&#39;ve reach maximum brightness, start dimming.</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>       <span class="co">// If we&#39;ve reached minimum brightness, start brightening.</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>       <span class="kw">if</span> <span class="op">((</span>count_up<span class="op">)&amp;&amp;(</span>din <span class="op">==</span> <span class="dv">254</span><span class="op">))</span> </span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>          count_up <span class="op">&lt;=</span> <span class="dv">0</span><span class="op">;</span>            </span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>       <span class="kw">else</span> <span class="kw">if</span> <span class="op">((~</span>count_up<span class="op">)&amp;&amp;(</span>din<span class="op">==</span><span class="dv">1</span><span class="op">))</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>          count_up <span class="op">&lt;=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="kw">endmodule</span></span></code></pre></div>
<h1 id="part-2-audio-signal-generation">Part 2: Audio Signal
Generation</h1>
<h2 id="pwm-square-wave-tones">PWM Square-Wave Tones</h2>
<p>You can generate an audio tone by sending the PWM signal directly to
the AMP2 Pmod’s <code class="sourceCode verilog">AIN</code> pin. The PWM
frequency corresponds to the pitch, and the PWM duty cycle corresponds
to the volume. A simple PWM audio modulator is implemented by two clock
dividers as shown below. The first clock divider sets the frequency
(i.e. the note) via a signal named <code
class="sourceCode verilog">f_clk</code>. The the second divider is
controlled by <code class="sourceCode verilog">f_clk</code>, and sets
the duty cycle (i.e. the volume) in increments from 0 to 256.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode verilog"><code class="sourceCode verilog"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> pwm_audio<span class="op">(</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>   <span class="dt">input</span>       clk<span class="op">,</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>   <span class="dt">input</span>       rst_n<span class="op">,</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>   <span class="dt">input</span> <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> volume<span class="op">,</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>   <span class="dt">input</span> <span class="op">[</span><span class="dv">9</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> N<span class="op">,</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>   <span class="dt">output</span> <span class="dt">reg</span>  sout</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>   <span class="op">);</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>   <span class="dt">reg</span> <span class="op">[</span><span class="dv">9</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> f_count<span class="op">;</span>  <span class="co">// counter for frequency synthesis</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>   <span class="dt">reg</span>       f_clk<span class="op">;</span>    <span class="co">// divided clock</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>   <span class="dt">reg</span> <span class="op">[</span><span class="dv">7</span><span class="op">:</span><span class="dv">0</span><span class="op">]</span> dc_count<span class="op">;</span> <span class="co">// counter for duty cycle</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>   <span class="kw">initial</span> <span class="kw">begin</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>      f_count  <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>      sout     <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>      f_clk    <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>      dc_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>   <span class="co">// First clock divider sets the tone frequency:</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>   <span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> clk<span class="op">,</span> <span class="kw">negedge</span> rst_n<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">if</span> <span class="op">(!</span>rst_n<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>         f_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>     f_clk   <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>      <span class="kw">else</span> <span class="kw">begin</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>         <span class="kw">if</span> <span class="op">(</span>f_count <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        f_count <span class="op">&lt;=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        f_clk   <span class="op">&lt;=</span> <span class="op">~</span>fclk<span class="op">);</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>     <span class="kw">end</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>     <span class="kw">else</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        f_count <span class="op">&lt;=</span> f_count <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">//  Second clock divider sets the duty cycle:</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>   <span class="kw">always</span> <span class="op">@(</span><span class="kw">posedge</span> f_clk<span class="op">,</span> <span class="kw">negedge</span> rst_n<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>      <span class="kw">if</span> <span class="op">(!</span>rst_n<span class="op">)</span> <span class="kw">begin</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>         dc_count <span class="op">&lt;=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>     sout  <span class="op">&lt;=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>      <span class="kw">else</span> <span class="kw">begin</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>         dc_count <span class="op">&lt;=</span> dc_count <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>         <span class="kw">if</span> <span class="op">(</span>dc_count <span class="op">&lt;</span> volume<span class="op">)</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>        sout <span class="op">&lt;=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>     <span class="kw">else</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>        sout <span class="op">&lt;=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="kw">endmodule</span></span></code></pre></div>
<p>The note frequency is controlled by the first clock divider ratio,
<span class="math inline"><em>N</em></span>. To determine the value of
<span class="math inline"><em>N</em></span> for a particular note, we
follow this procedure:</p>
<ul>
<li><span class="math inline"><em>f</em><sub><em>c</em></sub></span> =
the system clock frequency (100MHz for Basys3)</li>
<li><span class="math inline"><em>f</em></span> = the target note
frequency</li>
<li>Then <span class="math inline">$N = \frac{fc}{2f\times
256}$</span></li>
</ul>
<p>The factor of <code
class="sourceCode verilog"><span class="dv">256</span></code> in the
denominator allows for 256 clock cycles to control the duty cycle. This
equation produces fractional values which need to be rounded off. The
round-off error sometimes makes a note sound sharp or flat; for now,
we’ll have to live with that. A table of common musical notes, their
frequencies, and the associated divider values are shown below.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;"><span
class="math inline"><em>N</em></span></th>
<th style="text-align: center;">sout frequency</th>
<th style="text-align: center;">closest note</th>
<th style="text-align: center;">note frequency</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">747</td>
<td style="text-align: center;">261.46Hz</td>
<td style="text-align: center;">middle C</td>
<td style="text-align: center;">261.63Hz</td>
</tr>
<tr class="even">
<td style="text-align: center;">665</td>
<td style="text-align: center;">293.70</td>
<td style="text-align: center;">D</td>
<td style="text-align: center;">293.66</td>
</tr>
<tr class="odd">
<td style="text-align: center;">593</td>
<td style="text-align: center;">329.36</td>
<td style="text-align: center;">E</td>
<td style="text-align: center;">329.63</td>
</tr>
<tr class="even">
<td style="text-align: center;">559</td>
<td style="text-align: center;">349.40</td>
<td style="text-align: center;">F</td>
<td style="text-align: center;">349.23</td>
</tr>
<tr class="odd">
<td style="text-align: center;">498</td>
<td style="text-align: center;">392.19</td>
<td style="text-align: center;">G</td>
<td style="text-align: center;">392.00</td>
</tr>
<tr class="even">
<td style="text-align: center;">444</td>
<td style="text-align: center;">439.89</td>
<td style="text-align: center;">A</td>
<td style="text-align: center;">440.00</td>
</tr>
<tr class="odd">
<td style="text-align: center;">395</td>
<td style="text-align: center;">494.46</td>
<td style="text-align: center;">B</td>
<td style="text-align: center;">493.88</td>
</tr>
<tr class="even">
<td style="text-align: center;">373</td>
<td style="text-align: center;">523.63</td>
<td style="text-align: center;">C</td>
<td style="text-align: center;">523.25</td>
</tr>
</tbody>
</table>
<h2 id="top-module-design">Top Module Design</h2>
<p>To demonstrate the PWM audio module, create a top module with these
specifications:</p>
<ul>
<li><code class="sourceCode verilog">BtnC</code> is reset</li>
<li><code class="sourceCode verilog">BtnU</code>, <code
class="sourceCode verilog">BtnR</code>, <code
class="sourceCode verilog">BtnD</code>, and <code
class="sourceCode verilog">BtnL</code> are notes D, E, G and A,
respectively.</li>
<li>When a button is pressed, <code class="sourceCode verilog">N</code>
is set to the appropriate frequency and <code
class="sourceCode verilog">sout</code> is passed through to <code
class="sourceCode verilog">AIN</code> on the AMP2.</li>
<li>When no button is pressed, <code
class="sourceCode verilog">AIN</code> is zero.</li>
<li>Only one tone can be played at a time, so a second simultaneous
button-press must be ignored.</li>
</ul>
<h2 id="gain-and-shutdown_l-outputs">Gain and Shutdown_l outputs</h2>
<p>Besides the PWM signal, the Amp2 module needs two additional
signals:</p>
<ul>
<li><span class="alert">gain</span> – activate an optional amplifier
boost when 1</li>
<li><span class="alert">shutdown_l</span> – turn off the module when
0<br />
</li>
</ul>
<p>We can set both of these outputs to 1.</p>
<h2 id="constraining-the-design">Constraining the Design</h2>
<p>The PMod signals <span class="alert">sout</span>, <span
class="alert">gain</span> and <span class="alert">shutdown_l</span> all
need to be mapped to the correct <span class="alert">header I/O
positions</span>. I recommend plugging your AMP2 module into <span
class="alert">header JA</span>. Then the corresponding constraint
settings are:</p>
<pre class="XDC" data-language="XDC"><code>##Pmod Header JA
##Sch name = JA1
set_property PACKAGE_PIN J1 [get_ports {sout}]                  
set_property IOSTANDARD LVCMOS33 [get_ports {sout}]
#Sch name = JA2
set_property PACKAGE_PIN L2 [get_ports {gain}]                  
set_property IOSTANDARD LVCMOS33 [get_ports {gain}]
#Sch name = JA3
#set_property PACKAGE_PIN J2 [get_ports {JA[2]}]                    
#set_property IOSTANDARD LVCMOS33 [get_ports {JA[2]}]
#Sch name = JA4
set_property PACKAGE_PIN G2 [get_ports {shutdown_l}]                    
set_property IOSTANDARD LVCMOS33 [get_ports {shutdown_l}]
#Sch name = JA7
#set_property PACKAGE_PIN H1 [get_ports {JA[4]}]                    
#set_property IOSTANDARD LVCMOS33 [get_ports {JA[4]}]
##Sch name = JA8
#set_property PACKAGE_PIN K2 [get_ports {JA[5]}]                    
#set_property IOSTANDARD LVCMOS33 [get_ports {JA[5]}]
##Sch name = JA9
#set_property PACKAGE_PIN H2 [get_ports {JA[6]}]                    
#set_property IOSTANDARD LVCMOS33 [get_ports {JA[6]}]
##Sch name = JA10
#set_property PACKAGE_PIN G3 [get_ports {JA[7]}]                    
#set_property IOSTANDARD LVCMOS33 [get_ports {JA[7]}]</code></pre>
<h2 id="connecting-the-pmod-amp2">Connecting the Pmod AMP2</h2>
<p>Plug the module into header JA, on the top row, and make sure the
labels on pin “1” are matched between the module and Basys3.</p>
<figure>
<img src="figures/amp2_hw2.jpeg" style="width:70.0%" alt="image" />
<figcaption aria-hidden="true">image</figcaption>
</figure>
<h2 id="synthesize-implement-program-test">Synthesize, Implement,
Program, Test</h2>
<p>Then run Synthesis and Implementation, and try to resolve and error
messages or critical warnings that occur.</p>
<p>Finally, generate the bitstream, plug in the AMP2 module, program the
board, and listen for tones while you alter the switch settings.</p>
</body>
</html>
